‏<!DOCTYPE html>
‏<html lang="ar" dir="rtl">
‏<head>
‏  <meta charset="utf-8" />
‏  <meta name="viewport" content="width=device-width,initial-scale=1" />
‏  <title>AI-Assisted Mining — Prediction + Local Search (Local Gemini Key)</title>
‏  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
‏  <style>
‏    :root{--bg:#070708;--card:#0f1315;--fg:#e6f7ff;--accent:#22d3ee;--mut:#9fb0b8}
‏    *{box-sizing:border-box}
‏    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
‏    .wrap{max-width:980px;margin:12px auto;padding:14px}
‏    h1{color:var(--accent);margin:6px 0;font-size:20px;text-align:center}
‏    .card{background:var(--card);border-radius:12px;padding:12px;margin:10px 0;box-shadow:0 1px 0 #000 inset}
‏    label{display:block;font-size:13px;color:var(--mut);margin-bottom:6px}
‏    input,select,button,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #122;background:#071011;color:var(--fg);font-size:14px}
‏    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
‏    @media(max-width:720px){ .grid{grid-template-columns:1fr} }
‏    .row{display:flex;gap:8px}
‏    .row button{flex:1}
‏    button.primary{background:linear-gradient(90deg,#22d3ee,#60a5fa);color:#001;font-weight:700}
‏    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;direction:ltr}
‏    table{width:100%;border-collapse:collapse;margin-top:8px}
‏    th,td{padding:8px;border:1px solid #112;text-align:center}
‏    th{background:#062e2f}
‏    .muted{color:var(--mut);font-size:13px}
‏    .small{font-size:13px}
‏    .ok{color:#9ffb9f}
‏  </style>
‏</head>
‏<body>
‏<div class="wrap">
‏  <h1>تعدين بمساعدة AI — تخمين Nonce ثم بحث محلي</h1>

‏  <div class="card">
‏    <div class="grid">
‏      <div>
‏        <label>عنوان الكتلة (Header)</label>
‏        <input id="header" value="BlockHeaderExample" />
‏      </div>
‏      <div>
‏        <label>أصفار البداية (صعوبة بالـ hex)</label>
‏        <input id="zeros" type="number" min="1" max="7" value="4" />
‏      </div>
‏      <div>
‏        <label>نطاق Nonce (0..N)</label>
‏        <input id="nonceCap" type="number" value="10000000" />
‏      </div>
‏      <div>
‏        <label>حد المحاولات المحلي (Safety)</label>
‏        <input id="maxLocal" type="number" value="200000" />
‏      </div>
‏    </div>

‏    <div style="margin-top:10px" class="grid">
‏      <div>
‏        <label>مقدار البحث حول التخمين (radius)</label>
‏        <input id="radius" type="number" value="5000" />
‏      </div>
‏      <div>
‏        <label>top-K (عند فشل التخمين الأول)</label>
‏        <input id="topk" type="number" value="8" />
‏      </div>
‏    </div>

‏    <div style="margin-top:10px" class="muted small">سيتم: (1) طلب تخمين واحد من Gemini، (2) التحقق محليًا من التخمين، (3) بحث محلي ±radius، (4) عند الفشل نطلب قائمة top-K ونكرر.</div>
‏  </div>

‏  <div class="card">
‏    <label>مفتاح Gemini (سيُضمَّن داخل الطلب — استخدم الصفحة محليًا فقط)</label>
‏    <input id="geminiKey" value="AIzaSyCA4sXqUz7W3EU70wEZQ6_ttdL6osBlm4E" />
‏    <div class="muted small">تنبيه أمني: حتى لو نافذة محلية، احتفظ بالمفتاح في مكان آمن وغيّره إذا لزم.</div>
‏  </div>

‏  <div class="card">
‏    <div class="row">
‏      <button id="btnRun" class="primary">▶️ تشغيل دورة AI-Prediction + Local Search</button>
‏      <button id="btnRunRand">🔁 تشغيل التعدين العشوائي (Baseline)</button>
‏      <button id="btnClear">🧹 تفريغ النتائج</button>
‏    </div>
‏    <div style="margin-top:8px" class="muted small">ملاحظة: اختر صعوبة صغيرة (3–4) أثناء التجارب على الهاتف لضمان نتائج في وقت معقول.</div>
‏  </div>

‏  <div class="card">
‏    <div id="log" class="mono small" style="max-height:260px;overflow:auto"></div>
‏    <div id="out"></div>
‏  </div>
‏</div>

‏<script>
‏// ---------- Utilities ----------
‏const $ = id => document.getElementById(id);
‏function appendLog(s){ const d=document.createElement('div'); d.innerHTML=s; $('log').appendChild(d); $('log').scrollTop = $('log').scrollHeight; }
‏function clearOut(){ $('out').innerHTML=''; }
‏function clearLog(){ $('log').innerHTML=''; }

‏// ---------- Double SHA-256 via WebCrypto ----------
‏async function doubleSha256Hex(str){
‏  const enc = new TextEncoder();
‏  const first = await crypto.subtle.digest('SHA-256', enc.encode(str));
‏  const first8 = new Uint8Array(first);
‏  const second = await crypto.subtle.digest('SHA-256', first8);
‏  return Array.from(new Uint8Array(second)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
‏function meetsDifficulty(hexHash, zeros){ for(let i=0;i<zeros;i++){ if(hexHash[i] !== '0') return false; } return true; }

‏// ---------- Gemini API direct calls (single guess + topK) ----------
‏const GEMINI_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
‏async function geminiSingleGuess(header, zeros, key, nonceCap){
‏  const prompt = `You are assisting a cryptographic experiment. Given header = "${header}" and the requirement that double-SHA256(header + '|' + nonce) must start with ${zeros} hex zeros, return a single integer nonce (0..${nonceCap}) that is most likely to satisfy the condition. Return ONLY a JSON integer like: 123456. Do NOT include explanations.`;
‏  const body = { contents:[{ parts:[{ text: prompt }]}] };
‏  const t0 = performance.now();
‏  const res = await fetch(GEMINI_URL, { method:'POST', headers:{ 'Content-Type':'application/json', 'X-goog-api-key': key }, body: JSON.stringify(body) });
‏  const text = await res.text();
‏  const latency = performance.now() - t0;
‏  // extract first integer
‏  const m = text.match(/-?\d+/);
‏  if(!m) throw new Error('No integer returned by Gemini');
‏  return { guess: (Number(m[0])>>>0), raw: text, latency };
}
‏async function geminiTopK(header, zeros, key, nonceCap, K){
‏  const prompt = `Return a JSON array of up to ${K} integers (0..${nonceCap}) that are most likely to satisfy: double-SHA256(header + '|' + nonce) starts with ${zeros} hex zeros. Respond ONLY with a JSON array like: [123,456,...]. No other text.`;
‏  const body = { contents:[{ parts:[{ text: prompt }]}] };
‏  const t0 = performance.now();
‏  const res = await fetch(GEMINI_URL, { method:'POST', headers:{ 'Content-Type':'application/json', 'X-goog-api-key': key }, body: JSON.stringify(body) });
‏  const text = await res.text();
‏  const latency = performance.now() - t0;
‏  const m = text.match(/\[(?:.|\n)*?\]/);
‏  if(!m) throw new Error('No array returned by Gemini');
‏  try{ const arr = JSON.parse(m[0]); return { arr: arr.map(x=>Number(x)>>>0), raw:text, latency }; } catch(e){ throw new Error('Failed to parse Gemini array'); }
}

‏// ---------- Local search around guess ----------
‏async function localSearchAround(header, guess, zeros, radius, nonceCap, limitLocal){
‏  // Check guess then expand ±d
‏  let attempts = 0;
‏  function safe(n){ return n >= 0 && n <= nonceCap; }
‏  // check single nonce
‏  if(safe(guess)){
‏    attempts++;
‏    const h = await doubleSha256Hex(header + '|' + guess);
‏    if(meetsDifficulty(h, zeros)) return { found: guess, hash: h, attempts };
  }
‏  for(let d=1; d<=radius; d++){
‏    const a = guess + d;
‏    if(a <= nonceCap){ attempts++; const h = await doubleSha256Hex(header + '|' + a); if(meetsDifficulty(h, zeros)) return { found: a, hash: h, attempts }; }
‏    const b = guess - d;
‏    if(b >= 0){ attempts++; const h = await doubleSha256Hex(header + '|' + b); if(meetsDifficulty(h, zeros)) return { found: b, hash: h, attempts }; }
‏    if(attempts >= limitLocal) break;
‏    if((d & 0x3ff) === 0) await new Promise(r=>setTimeout(r,0)); // yield
  }
‏  return { found: null, attempts };
}

‏// ---------- Main cycle: AI guess -> local search -> topK fallback ----------
‏async function runAICycle(){
‏  clearLog(); clearOut(); appendLog('<b>▶️ بدء دورة AI Prediction + Local Search</b>');
‏  const header = $('header').value.trim(); const zeros = Number($('zeros').value)||3; const nonceCap = Number($('nonceCap').value)||10000000; const radius = Number($('radius').value)||5000; const topk = Number($('topk').value)||8; const maxLocal = Number($('maxLocal').value)||200000; const key = $('geminiKey').value.trim();

‏  const metrics = { api_calls:0, api_latency_ms:0, local_attempts:0, total_time_ms:0 };
‏  const tStart = performance.now();

‏  try{
‏    // 1) single guess
‏    appendLog('طلب تخمين واحد من Gemini...');
‏    metrics.api_calls++;
‏    const gRes = await geminiSingleGuess(header, zeros, key, nonceCap);
‏    metrics.api_latency_ms += gRes.latency;
‏    appendLog(`Gemini → guess = <span class="mono">${gRes.guess}</span> (latency ${gRes.latency.toFixed(0)} ms)`);

‏    // 2) local search around guess
‏    appendLog(`التحقق محليًا حول التخمين بمدى radius=${radius} ...`);
‏    const local1 = await localSearchAround(header, gRes.guess, zeros, radius, nonceCap, maxLocal);
‏    metrics.local_attempts += local1.attempts;
‏    if(local1.found){
‏      const total = performance.now()-tStart; metrics.total_time_ms = total;
‏      appendLog(`<b class="ok">✅ نجح AI! nonce=${local1.found} — hash=${local1.hash.slice(0,20)}…</b>`);
‏      appendResults('AI (single guess + local search) — نجاح', gRes, local1, metrics);
‏      return;
    }

‏    appendLog('لم ينجح التخمين الأول — نطلب الآن قائمة top-K من Gemini...');
‏    // 3) top-K fallback
‏    metrics.api_calls++;
‏    const topRes = await geminiTopK(header, zeros, key, nonceCap, topk);
‏    metrics.api_latency_ms += topRes.latency;
‏    appendLog(`Gemini → topK (latency ${topRes.latency.toFixed(0)} ms): <span class="mono">[${topRes.arr.join(', ')}]</span>`);

‏    // 4) iterate topK with smaller radius
‏    const smallRadius = Math.min(1000, Math.floor(radius/5));
‏    for(const cand of topRes.arr){
‏      appendLog(`التحقق حول المرشح ${cand} (±${smallRadius}) ...`);
‏      const res = await localSearchAround(header, cand, zeros, smallRadius, nonceCap, Math.max(5000, Math.floor(maxLocal/topk)) );
‏      metrics.local_attempts += res.attempts;
‏      if(res.found){
‏        const total = performance.now()-tStart; metrics.total_time_ms = total;
‏        appendLog(`<b class=ok>✅ نجح AI عبر top-K! nonce=${res.found} — hash=${res.hash.slice(0,20)}…</b>`);
‏        appendResults('AI (topK fallback) — نجاح', {guessList: topRes.arr}, res, metrics);
‏        return;
      }
    }

    // 5) فشل كامل — العرض
‏    metrics.total_time_ms = performance.now()-tStart;
‏    appendLog('<span class="muted">ℹ️ فشل AI في إيجاد حل ضمن القيود. تنفيذ استخراج عشوائي كـ baseline يمكن البدء به.</span>');
‏    appendResults('AI — فشل', {guess: gRes.guess, raw:gRes.raw}, {found:null, attempts:metrics.local_attempts}, metrics);
‏  }catch(err){
‏    appendLog(`<span style="color:#ff8a8a">❌ خطأ: ${err.message}</span>`);
  }
}

‏// ---------- Random baseline ----------
‏async function runRandomBaseline(){
‏  clearLog(); clearOut(); appendLog('▶️ بدء التعدين العشوائي (Baseline)');
‏  const header = $('header').value.trim(); const zeros = Number($('zeros').value)||3; const nonceCap = Number($('nonceCap').value)||10000000; const maxLocal = Number($('maxLocal').value)||200000; setTimeout(()=>{},0);
‏  const t0 = performance.now(); let attempts = 0; let found=null; let foundHash='';
‏  while(attempts < maxLocal){
‏    const nonce = Math.floor(Math.random()*nonceCap);
‏    attempts++;
‏    const h = await doubleSha256Hex(header + '|' + nonce);
‏    if(meetsDifficulty(h, zeros)){ found = nonce; foundHash = h; break; }
‏    if((attempts & 0x3ff) === 0) await new Promise(r=>setTimeout(r,0));
  }
‏  const t1 = performance.now(); appendLog(`محاولات: ${attempts}, زمن: ${(t1-t0).toFixed(1)} ms`);
‏  if(found){ appendLog(`<b class=ok>✅ تم العثور على nonce=${found} — hash=${foundHash.slice(0,24)}…</b>`); appendResults('Random Baseline', {}, {found, attempts}, {total_time_ms: t1-t0}); }
‏  else { appendLog('<span class="muted">– لم يتم العثور على حل ضمن الحد</span>'); appendResults('Random Baseline — no result', {}, {found:null, attempts}, {total_time_ms: t1-t0}); }
}

‏// ---------- UI result rendering ----------
‏function appendResults(title, guessInfo, localInfo, metrics){
‏  const out = document.createElement('div'); out.innerHTML = `<h3 style="margin:8px 0 4px">${title}</h3>`;
‏  const table = document.createElement('table'); table.innerHTML = `
‏    <thead><tr><th>البند</th><th>القيمة</th></tr></thead>
‏    <tbody>
‏      <tr><td>API calls</td><td class="mono">${metrics.api_calls??0}</td></tr>
‏      <tr><td>API latency (ms)</td><td class="mono">${metrics.api_latency_ms?.toFixed(1)??0}</td></tr>
‏      <tr><td>Local attempts</td><td class="mono">${metrics.local_attempts??localInfo.attempts??0}</td></tr>
‏      <tr><td>Total time (ms)</td><td class="mono">${(metrics.total_time_ms||0).toFixed(1)}</td></tr>
‏      <tr><td>Nonce found</td><td class="mono">${localInfo.found??'—'}</td></tr>
‏      <tr><td>Hash (prefix)</td><td class="mono">${localInfo.hash?localInfo.hash.slice(0,24)+'…':'—'}</td></tr>
‏    </tbody>
  `;
‏  out.appendChild(table);
‏  $('out').appendChild(out);
‏  $('out').scrollTop = $('out').scrollHeight;
}

‏// ---------- wiring ----------
‏$('btnRun').onclick = ()=>{ runAICycle(); };
‏$('btnRunRand').onclick = ()=>{ runRandomBaseline(); };
‏$('btnClear').onclick = ()=>{ clearLog(); clearOut(); };

‏// Convenience: focus header on load
‏$('header').focus();
‏</script>
‏</body>
‏</html>
