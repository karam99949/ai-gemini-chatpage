<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monero Debug Miner</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0b0f14;color:#d8f1e2;padding:18px}
    .card{max-width:900px;margin:0 auto;background:#07121a;padding:18px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    input,select,button{padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#09151b;color:inherit}
    textarea{width:100%;height:280px;margin-top:12px;background:#07121a;color:#8ff0a9;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);font-family:monospace;white-space:pre-wrap}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .col{flex:1;min-width:160px}
    button.primary{background:#f7931a;color:#051018;border:none}
    button.danger{background:#333;color:#fff;border:none}
    small{color:#9db0b5}
  </style>
</head>
<body>
  <div class="card">
    <h2>تشخيص وتشغيل تعدين مونيرو (XMR)</h2>
    <p><small>أدخل بياناتك ثم اضغط بدء. السجل يسجّل كل شيء — انسخ السجل وشاركه لو احتجت مساعدة إضافية.</small></p>

    <div class="row">
      <div class="col">
        <label>محفظة XMR</label><br/>
        <input id="wallet" value="YOUR_XMR_WALLET_ADDRESS" />
      </div>
      <div class="col">
        <label>عامل (Worker)</label><br/>
        <input id="worker" value="web1" />
      </div>
      <div class="col">
        <label>خادم WebSocket (poolServer)</label><br/>
        <input id="poolServer" value="wss://pool.supportxmr.com:443" />
      </div>
    </div>

    <div style="margin-top:12px" class="row">
      <div class="col">
        <label>خيوط (threads)</label><br/>
        <select id="threads"><option value="-1">تلقائي</option><option>1</option><option>2</option><option>4</option></select>
      </div>
      <div class="col">
        <label>throttle %</label><br/>
        <select id="throttle"><option>20</option><option>40</option><option>60</option></select>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button id="startBtn" class="primary">بدء</button>
        <button id="stopBtn" class="danger" disabled style="margin-left:8px">إيقاف</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <div><small>حالة:</small> <span id="status">جاهز</span></div>
      <div style="margin-top:8px" class="row">
        <div class="col"><small>هاش/ثانية</small><div id="hps">0 H/s</div></div>
        <div class="col"><small>إجمالي هاشات</small><div id="total">0</div></div>
        <div class="col"><small>مقبولة</small><div id="accepted">0</div></div>
      </div>
    </div>

    <textarea id="log" readonly placeholder="سجل الأحداث يظهر هنا..."></textarea>
  </div>

<script>
  const $ = id => document.getElementById(id);
  const logEl = $('log'), statusEl = $('status'), startBtn = $('startBtn'), stopBtn = $('stopBtn');
  const hpsEl = $('hps'), totalEl = $('total'), accEl = $('accepted');
  let minerLoaded = false, statsInterval = null;

  function log(msg){
    const t = new Date().toLocaleTimeString();
    logEl.value += `[${t}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
    console.log(msg);
  }

  function resetStats(){ hpsEl.textContent='0 H/s'; totalEl.textContent='0'; accEl.textContent='0'; }

  // Attempt to test raw WebSocket connectivity to poolServer
  function testWebSocket(serverUrl, timeoutMs = 5000){
    return new Promise((resolve) => {
      let didResolve = false;
      try {
        const ws = new WebSocket(serverUrl);
        const onDone = (ok, reason) => {
          if(didResolve) return;
          didResolve = true;
          try{ ws.close(); }catch(e){}
          resolve({ok, reason});
        };
        ws.onopen = () => onDone(true, 'connected');
        ws.onerror = (e) => onDone(false, 'ws error');
        ws.onclose = () => { if(!didResolve) onDone(false,'closed'); };
        setTimeout(()=> { if(!didResolve) onDone(false,'timeout'); }, timeoutMs);
      } catch (err){
        resolve({ok:false, reason: err.message});
      }
    });
  }

  // Load external miner script and perform robust checks
  async function loadAndStart(){
    const wallet = $('wallet').value.trim();
    if(!wallet || wallet === 'YOUR_XMR_WALLET_ADDRESS'){ alert('ضع عنوان محفظتك أولاً'); return; }
    const poolServer = $('poolServer').value.trim();
    startBtn.disabled = true; statusEl.textContent='جارٍ التحضير...';
    log('بدء التحضير: poolServer=' + poolServer);

    // 1) اختبار WebSocket مباشر إلى الخادم
    log('اختبار اتصال WebSocket خام إلى ' + poolServer + ' ...');
    const wsTest = await testWebSocket(poolServer, 4000);
    log('نتيجة اختبار WebSocket: ' + JSON.stringify(wsTest));
    if(!wsTest.ok){
      log('تحذير: اتصال WebSocket لم ينجح — قد يكون السبب: endpoint خاطئ، سياسات CORS، أو المتصفح يمنع الاتصال.');
      // لكن سنستمر بمحاولة تحميل المكتبة لأنه قد تستخدم Proxy داخلي يدير الاتصال
    }

    // 2) تحميل سكربت التعدين (من مصدر موثوق) — ضع هنا رابط مكتبة تعمل لديك
    const scriptUrl = 'https://script.monerominer.rocks'; // إذا لديك رابط آخر ضعّه هنا
    log('تحميل سكربت التعدين من: ' + scriptUrl);
    try {
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = scriptUrl;
        s.onload = () => resolve();
        s.onerror = (e) => reject(new Error('فشل تحميل السكربت'));
        document.head.appendChild(s);
      });
      log('تم تحميل السكربت.');
    } catch(err){
      log('خطأ: ' + err.message);
      statusEl.textContent = 'خطأ تحميل المكتبة';
      startBtn.disabled = false;
      return;
    }

    // 3) التحقق من وجود واجهات تشغيل معروفة
    log('التحقق من دوال التشغيل في السكربت...');
    const checks = {
      startMining: typeof window.startMining === 'function',
      stopMining: typeof window.stopMining === 'function',
      ClientAnonymous: typeof window.Client === 'object' || typeof window.Client === 'function',
      globalMiner: !!window.miner
    };
    log('نتيجة التحقق: ' + JSON.stringify(checks));

    // إذا وجدنا startMining — ننفذها
    try {
      const threadsVal = parseInt($('threads').value,10);
      const threads = isNaN(threadsVal) ? -1 : threadsVal;
      const throttle = parseInt($('throttle').value,10);
      if(checks.startMining){
        // بعض المكتبات تتطلب pool name منفصل؛ هنا نمرر poolServer في global var حسب بعض المكتبات
        window.__poolServer = poolServer;
        window.__throttle = throttle;
        log('استدعاء startMining(...) — نمرر poolServer كمتحول عام إن احتاجته المكتبة');
        // مثال عام: startMining(pool, wallet, worker, threads, password)
        try {
          startMining(poolServer, wallet, $('worker').value || '', threads, 'x');
          log('نُفذ startMining()');
        } catch(e){
          log('خطأ عند نداء startMining: ' + e.message);
        }
      } else if (checks.ClientAnonymous && typeof window.Client === 'function'){
        // بعض المكتبات تستخدم Client.Anonymous أو new Client.Anonymous(...)
        try {
          log('إنشاء Client.Anonymous...');
          if (window.Client && typeof window.Client.Anonymous === 'function'){
            window.miner = new window.Client.Anonymous(wallet, { throttle: throttle/100, threads: threads });
            if (window.miner.start) window.miner.start();
            log('تم إنشاء وتشغيل Client.Anonymous');
          } else {
            log('واجهة Client.Anonymous غير متوافرة');
          }
        } catch(e){
          log('خطأ أثناء إنشاء Client.Anonymous: ' + e.message);
        }
      } else {
        log('لم يتم العثور على دوال تشغيل واضحة في السكربت. اطلع على الوثائق الخاصة بالمكتبة أو جرب مكتبة أخرى.');
      }
    } catch(err){
      log('خطأ عام أثناء محاولة تشغيل المكتبة: ' + err.message);
    }

    // 4) بعد النداء: نراقب المتغيرات المحتملة ونطبعها كل ثانية
    let attempts = 0;
    statsInterval = setInterval(()=>{
      attempts++;
      // اجمع بيانات لو توفرت
      const hps = (window.miner && typeof window.miner.getHashesPerSecond === 'function') ? window.miner.getHashesPerSecond() : (window.hashesPerSecond || window.hashrate || 0);
      const total = (window.miner && typeof window.miner.getTotalHashes === 'function') ? window.miner.getTotalHashes() : (window.totalHashes || 0);
      const accepted = (window.miner && typeof window.miner.getAcceptedHashes === 'function') ? window.miner.getAcceptedHashes() : (window.acceptedShares || 0);
      hpsEl.textContent = (hps && hps.toFixed) ? hps.toFixed(2) + ' H/s' : (hps + ' H/s');
      totalEl.textContent = total || 0;
      accEl.textContent = accepted || 0;

      // إن لم تصل أية بيانات بعد 8 ثواني نطبع إشعار تشخيصي
      if(attempts === 8){
        log('تنبيه: لم نرَ تشغيلاً واضحاً بعد 8 ثواني. تحقق من: 1) أن poolServer يقبل WebSocket 2) أن الرابط يستخدم wss:// 3) أن السكربت الذي حملته يدعم التشغيل من المتصفح.');
      }
      if(attempts >= 30){
        log('انتهى وقت المراقبة الأولي — لم تظهر إحصاءات. أوقف وأعد المحاولة أو أرسل لي السجل الكامل.');
        clearInterval(statsInterval);
      }
    }, 1000);

    statusEl.textContent = 'جارٍ محاولة التشغيل — راجع السجل أدناه';
    stopBtn.disabled = false;
  }

  startBtn.addEventListener('click', () => loadAndStart());
  stopBtn.addEventListener('click', () => {
    try { if(typeof stopMining === 'function') stopMining(); } catch(e){}
    try { if(window.miner && window.miner.stop) window.miner.stop(); } catch(e){}
    if(statsInterval) clearInterval(statsInterval);
    resetStats(); log('أوقف المستخدم التعدين'); statusEl.textContent='متوقف'; startBtn.disabled = false; stopBtn.disabled = true;
  });

  // نصيحة سريعة تظهر في Console أيضاً
  log('الصفحة جاهزة — أدخل محفظتك ثم اضغط "بدء"');

</script>
</body>
</html>
